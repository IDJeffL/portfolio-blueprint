"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useApollo = exports.addApolloState = exports.getApolloClient = exports.APOLLO_STATE_PROP_NAME = void 0;
const react_1 = require("react");
const deepmerge_1 = __importDefault(require("deepmerge"));
const isEqual_js_1 = __importDefault(require("lodash/isEqual.js"));
const client_1 = require("@apollo/client");
const index_js_1 = require("./config/index.js");
const index_js_2 = require("./hooks/index.js");
const getGraphqlEndpoint_js_1 = require("./lib/getGraphqlEndpoint.js");
exports.APOLLO_STATE_PROP_NAME = '__APOLLO_STATE__';
const windowApolloState = typeof window !== 'undefined' ? window[exports.APOLLO_STATE_PROP_NAME] : {};
let apolloClient;
function createApolloClient() {
    const { possibleTypes } = (0, index_js_1.getConfig)();
    let inMemoryCacheObject = {
        possibleTypes,
        typePolicies: {
            RootQuery: {
                queryType: true,
            },
            RootMutation: {
                mutationType: true,
            },
        },
    };
    inMemoryCacheObject = index_js_2.hooks.applyFilters('apolloClientInMemoryCacheOptions', inMemoryCacheObject, {});
    let apolloClientOptions = {
        ssrMode: typeof window === 'undefined',
        connectToDevTools: typeof window !== 'undefined',
        uri: (0, getGraphqlEndpoint_js_1.getGraphqlEndpoint)(),
        cache: new client_1.InMemoryCache(inMemoryCacheObject).restore(windowApolloState),
    };
    apolloClientOptions = index_js_2.hooks.applyFilters('apolloClientOptions', apolloClientOptions, {});
    return new client_1.ApolloClient(apolloClientOptions);
}
function getApolloClient(initialState = null) {
    // eslint-disable-next-line @typescript-eslint/naming-convention, no-underscore-dangle
    const _apolloClient = apolloClient !== null && apolloClient !== void 0 ? apolloClient : createApolloClient();
    // If your page has Next.js data fetching methods that use Apollo Client, the initial state
    // gets hydrated here
    if (initialState) {
        // Get existing cache, loaded during client side data fetching
        const existingCache = _apolloClient.extract();
        // Merge the initialState from getStaticProps/getServerSideProps in the existing cache
        const data = (0, deepmerge_1.default)(existingCache, initialState, {
            // eslint-disable-next-line @typescript-eslint/no-unsafe-return
            arrayMerge: (destination, source) => [
                ...source,
                ...destination.filter((d) => source.every((s) => !(0, isEqual_js_1.default)(d, s))),
            ],
        });
        // Restore the cache with the merged data
        _apolloClient.cache.restore(data);
    }
    // For SSG and SSR always create a new Apollo Client
    if (typeof window === 'undefined')
        return _apolloClient;
    // Create the Apollo Client once in the client
    if (!apolloClient)
        apolloClient = _apolloClient;
    return _apolloClient;
}
exports.getApolloClient = getApolloClient;
function addApolloState(client, pageProps) {
    if (pageProps === null || pageProps === void 0 ? void 0 : pageProps.props) {
        // eslint-disable-next-line no-param-reassign
        pageProps.props[exports.APOLLO_STATE_PROP_NAME] = client.cache.extract();
    }
    return pageProps;
}
exports.addApolloState = addApolloState;
function useApollo(pageProps) {
    const state = pageProps[exports.APOLLO_STATE_PROP_NAME];
    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
    const store = (0, react_1.useMemo)(() => getApolloClient(state), [state]);
    return store;
}
exports.useApollo = useApollo;
